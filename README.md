# Ansible-плейбук для настройки Debian 11 с PostgreSQL 16

Данный плейбук предназначен для автоматизированной настройки сервера Debian 11 с установкой и конфигурацией PostgreSQL 16. Он выполняет следующие действия:

1. **Создание администратора:**
   - Создает пользователя с именем `{{ admin_user }}`.
   - Настраивает sudo без запроса пароля для данного пользователя.

2. **Настройка SSH:**
   - Генерирует пару SSH-ключей для пользователя `{{ admin_user }}`.
   - Убеждается, что директория `.ssh` существует и имеет правильные права доступа.
   - Добавляет публичный ключ в `authorized_keys`.
   - Извлекает приватный ключ и сохраняет его локально.
   - Изменяет порт SSH на указанный в переменной `{{ ssh_port }}`.
   - Отключает вход по SSH для пользователя root.

3. **Обновление системы:**
   - Обновляет кэш пакетов APT.
   - Выполняет обновление всех установленных пакетов.
   - Устанавливает NTP для синхронизации времени.

4. **Установка зависимостей:**
   - Устанавливает необходимые пакеты: `gnupg`, `lsb-release`, `wget`, `python3-psycopg2`.

5. **Установка PostgreSQL 16:**
   - Добавляет GPG-ключ PostgreSQL.
   - Добавляет репозиторий PostgreSQL.
   - Обновляет кэш пакетов APT.
   - Устанавливает PostgreSQL версии 16.

6. **Конфигурация PostgreSQL:**
   - Редактирует файл `postgresql.conf`, устанавливая параметры из переменных:
     - `listen_addresses`: адреса, на которых PostgreSQL будет слушать подключения.
     - `shared_buffers`: объем памяти, выделенный для буферов базы данных. **Рекомендуется** устанавливать 25% от общей оперативной памяти сервера, но не более 8GB.
     - `max_connections`: максимальное количество одновременных подключений к базе данных. **Рекомендуется** устанавливать в соответствии с ожидаемой нагрузкой; по умолчанию 100.
     - `effective_cache_size`: приблизительный объем памяти, доступный для кэширования диска операционной системы. **Рекомендуется** устанавливать около 50-75% от общей оперативной памяти.
     - `work_mem`: объем памяти, используемый для операций сортировки и хеширования перед записью на диск. **Рекомендуется** 4MB на каждое соединение, но может быть увеличено для сложных запросов.
     - `maintenance_work_mem`: объем памяти для операций обслуживания, таких как `VACUUM` и `CREATE INDEX`. **Рекомендуется** увеличить для ускорения крупных операций, например, до 64MB или больше.
     - `checkpoint_timeout`: интервал времени между контрольными точками записи на диск. **Рекомендуется** устанавливать от 5 до 15 минут.
     - `checkpoint_completion_target`: доля контрольного интервала, в течение которой PostgreSQL пытается завершить запись контрольной точки. **Рекомендуется** значение от 0.5 до 0.9 для сглаживания нагрузки на диск.
     - `max_wal_size`: максимальный размер журнала предзаписи (WAL) перед выполнением контрольной точки. **Рекомендуется** увеличить для улучшения производительности записи.
     - `min_wal_size`: минимальный размер WAL перед удалением старых журналов.
     - **Параметры логирования:**
       - `logging_collector`: включает сборщик логов (`on` или `off`). **Рекомендуется** включить для детального логирования.
       - `log_directory`: директория для сохранения файлов логов (например, `pg_log`).
       - `log_filename`: шаблон имени файла лога (например, `postgresql-%a.log`, где `%a` заменяется на день недели).
       - `log_rotation_age`: как часто выполнять ротацию логов по времени (например, `1d` для ежедневной ротации).
       - `log_rotation_size`: как часто выполнять ротацию логов по размеру (например, `10MB`).
       - `log_destination`: формат и место сохранения логов (например, `csvlog` для логов в формате CSV).
     - `port`: порт, на котором PostgreSQL будет принимать подключения (по умолчанию `5432`).
   - Редактирует файл `pg_hba.conf`, позволяя подключение по паролю с любых адресов.
   - Перезапускает службу PostgreSQL.
   - Создает пользователя PostgreSQL с именем `{{ db_user }}` и паролем `{{ db_password }}`.

7. **Настройка брандмауэра (iptables):**
   - Устанавливает `iptables-persistent` и `rsyslog`.
   - Запускает службу `rsyslog`.
   - Очищает текущие правила iptables.
   - Разрешает установленные соединения и локальный трафик.
   - Разрешает входящие подключения на порты `{{ ssh_port }}` (SSH) и `{{ postgresql_port }}` (PostgreSQL).
   - Устанавливает политику DROP для всех остальных входящих соединений.
   - Включает логирование сброшенных пакетов.
   - Сохраняет правила iptables.
   - Настраивает `rsyslog` для записи логов iptables в отдельный файл.

8. **Перезагрузка сервера:**
   - Выполняет перезагрузку для применения всех изменений.

## Файл переменных `env.yml`

```yaml
admin_user: "XXXXXXX"         # Имя администратора системы
db_user: "XXXXXXX"            # Имя пользователя PostgreSQL
db_password: "XXXXXXX"        # Пароль пользователя PostgreSQL
postgresql_port: XXXX         # Порт для PostgreSQL (рекомендуется 5432 по умолчанию)
ssh_port: XXXX                # Порт для SSH (рекомендуется выбрать нестандартный порт для безопасности)
shared_buffers: "512MB"       # Буферы памяти PostgreSQL (рекомендуется ~25% от RAM)
work_mem: "4MB"               # Память для операций сортировки и хеширования (рекомендуется 4MB или больше)
maintenance_work_mem: "64MB"  # Память для операций обслуживания (увеличение ускоряет VACUUM и создание индексов)
effective_cache_size: "1.5GB" # Ожидаемый размер дискового кэша (рекомендуется ~50-75% от RAM)
max_connections: 50           # Максимальное количество подключений 
logging_collector: "on"       # Включение сбора логов 
log_directory: "pg_log"       # Директория для логов
log_filename: "postgresql-%a.log" # Шаблон имени файла лога
log_rotation_age: "1d"        # Ротация логов по времени 
log_rotation_size: "10MB"     # Ротация логов по размеру
log_destination: "csvlog"     # Формат и место сохранения логов (CSV формат для удобства анализа)
checkpoint_timeout: "15min"   # Интервал между контрольными точками (рекомендуется 5-15 минут)
checkpoint_completion_target: 0.7  # Цель завершения контрольной точки (рекомендуется 0.5-0.9)
max_wal_size: "1GB"           # Максимальный размер WAL 
min_wal_size: "80MB"          # Минимальный размер WAL
```

**Рекомендации по настройке параметров:**

- **shared_buffers**: Оптимальное значение зависит от объема доступной оперативной памяти. Обычно рекомендуется установить 25% от общей RAM, но не более 8GB, чтобы избежать давления на память операционной системы.

- **effective_cache_size**: Этот параметр сообщает планировщику запросов, сколько кэша доступно для PostgreSQL. Рекомендуется установить около 50-75% от общей оперативной памяти.

- **work_mem**: Увеличение этого параметра может улучшить производительность операций сортировки и хеширования. Но слишком высокое значение может привести к исчерпанию памяти.

- **maintenance_work_mem**: Высокие значения ускоряют операции обслуживания, такие как `VACUUM` и `CREATE INDEX`. При частом использовании операций рекомендуется увеличить данное значение.

- **max_connections**: Установка слишком высокого значения может привести к чрезмерному использованию ресурсов.

- **checkpoint_timeout** и **checkpoint_completion_target**: Эти параметры влияют на частоту и продолжительность контрольных точек. Более редкие контрольные точки (большее значение `checkpoint_timeout`) снижают нагрузку на диск, но увеличивают время восстановления после сбоя.

- **max_wal_size** и **min_wal_size**: Увеличение `max_wal_size` позволяет реже выполнять контрольные точки, что может улучшить производительность записи.

- **logging_collector** и связанные параметры логирования: Включение детального логирования помогает в диагностике проблем и мониторинге производительности.

- **postgresql_port** и **ssh_port**: Использование нестандартных портов может немного повысить безопасность, скрывая сервисы от простых сканирований портов.

**Примечание:** Важные данные, такие как имена пользователей, пароли и порты, заменены на "X" для безопасности. Настраивайте параметры в соответствии с ресурсами вашего сервера и требованиями вашего приложения.
